<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Library Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="sidebar bg-blue-800 text-white w-64 flex-shrink-0">
            <div class="p-4 flex items-center space-x-2 border-b border-blue-700">
                <i class="fas fa-book-open text-2xl"></i>
                <h1 class="text-xl font-bold">Digital Library</h1>
            </div>
            <nav class="mt-4">
                <div class="px-4 py-3 cursor-pointer hover:bg-blue-700 flex items-center space-x-2 active-tab" id="dashboard-tab">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="px-4 py-3 cursor-pointer hover:bg-blue-700 flex items-center space-x-2" id="books-tab">
                    <i class="fas fa-book"></i>
                    <span>Books Management</span>
                </div>
                <div class="px-4 py-3 cursor-pointer hover:bg-blue-700 flex items-center space-x-2" id="users-tab">
                    <i class="fas fa-users"></i>
                    <span>Users Management</span>
                </div>
                <div class="px-4 py-3 cursor-pointer hover:bg-blue-700 flex items-center space-x-2" id="borrow-tab">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Borrow/Return</span>
                </div>
                <div class="px-4 py-3 cursor-pointer hover:bg-blue-700 flex items-center space-x-2" id="reports-tab">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <!-- Header -->
            <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800" id="page-title">Dashboard</h2>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" placeholder="Search..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="text-sm font-medium">Admin</span>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <main class="p-6">
                <!-- Dashboard Section -->
                <div id="dashboard-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-500">Total Books</p>
                                    <h3 class="text-2xl font-bold" id="total-books">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <i class="fas fa-book text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-500">Total Users</p>
                                    <h3 class="text-2xl font-bold" id="total-users">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-users text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-500">Borrowed Books</p>
                                    <h3 class="text-2xl font-bold" id="borrowed-books">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                    <i class="fas fa-exchange-alt text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-gray-500">Overdue Books</p>
                                    <h3 class="text-2xl font-bold" id="overdue-books">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-red-100 text-red-600">
                                    <i class="fas fa-exclamation-triangle text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold">Recent Borrowed Books</h3>
                                <button class="text-blue-600 text-sm">View All</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="text-left text-gray-500 border-b">
                                            <th class="pb-2">Book</th>
                                            <th class="pb-2">User</th>
                                            <th class="pb-2">Borrow Date</th>
                                            <th class="pb-2">Due Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-borrowed">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold">Popular Books</h3>
                                <button class="text-blue-600 text-sm">View All</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4" id="popular-books">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Books Management Section -->
                <div id="books-section" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">Books Management</h3>
                        <button id="add-book-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                            <i class="fas fa-plus"></i>
                            <span>Add New Book</span>
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b flex justify-between items-center">
                            <div class="flex space-x-4">
                                <div class="relative">
                                    <input type="text" placeholder="Search books..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="book-search">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                                <select class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="book-filter">
                                    <option value="all">All Books</option>
                                    <option value="available">Available</option>
                                    <option value="borrowed">Borrowed</option>
                                </select>
                            </div>
                            <button class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="text-left text-gray-500 border-b">
                                        <th class="p-4">ID</th>
                                        <th class="p-4">Title</th>
                                        <th class="p-4">Author</th>
                                        <th class="p-4">Publisher</th>
                                        <th class="p-4">Pages</th>
                                        <th class="p-4">Quantity</th>
                                        <th class="p-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="books-table-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t flex justify-between items-center">
                            <div class="text-sm text-gray-500">
                                Showing <span id="book-start">1</span> to <span id="book-end">10</span> of <span id="book-total">0</span> entries
                            </div>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 border rounded-lg disabled:opacity-50" id="book-prev" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="px-3 py-1 border rounded-lg disabled:opacity-50" id="book-next" disabled>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Add/Edit Book Modal -->
                <div id="add-book-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
                    <div class="bg-white w-full max-w-md rounded-lg shadow-lg p-6 relative">
                        <h2 id="modal-title" class="text-lg font-semibold mb-4">Add New Book</h2>
                        <form id="add-book-form" class="space-y-4">
                            <input type="hidden" name="bookId" id="book-id">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Title</label>
                                <input type="text" name="title" required class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Author</label>
                                <input type="text" name="author" required class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Publisher</label>
                                <input type="text" name="publisher" required class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Pages</label>
                                <input type="number" name="numPages" min="1" required class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Quantity</label>
                                <input type="number" name="quantity" min="1" required class="w-full border px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="flex justify-end space-x-2 pt-4">
                                <button type="button" id="cancel-add-book" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                            </div>
                        </form>
                        <button id="close-modal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>


                <!-- Users Management Section -->
                <div id="users-section" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">Users Management</h3>
                        <button id="add-user-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                            <i class="fas fa-plus"></i>
                            <span>Add New User</span>
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b flex justify-between items-center">
                            <div class="relative">
                                <input type="text" placeholder="Search users..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="user-search">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <button class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="text-left text-gray-500 border-b">
                                        <th class="p-4">ID</th>
                                        <th class="p-4">Name</th>
                                        <th class="p-4">Email</th>
                                        <th class="p-4">Password</th>
                                        <th class="p-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t flex justify-between items-center">
                            <div class="text-sm text-gray-500">
                                Showing <span id="user-start">1</span> to <span id="user-end">10</span> of <span id="user-total">0</span> entries
                            </div>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 border rounded-lg disabled:opacity-50" id="user-prev" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="px-3 py-1 border rounded-lg disabled:opacity-50" id="user-next" disabled>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Borrow/Return Section -->
                <div id="borrow-section" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">Borrow/Return Management</h3>
                        <button id="new-borrow-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                            <i class="fas fa-exchange-alt"></i>
                            <span>New Borrow</span>
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="relative">
                                    <input type="text" placeholder="Search borrow slips..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full" id="borrow-search">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                                <select class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full" id="borrow-status">
                                    <option value="all">All Status</option>
                                    <option value="borrowed">Borrowed</option>
                                    <option value="returned">Returned</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                                <input type="date" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full" id="borrow-date">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="text-left text-gray-500 border-b">
                                        <th class="p-4">Slip ID</th>
                                        <th class="p-4">User</th>
                                        <th class="p-4">Book</th>
                                        <th class="p-4">Borrow Date</th>
                                        <th class="p-4">Due Date</th>
                                        <th class="p-4">Status</th>
                                        <th class="p-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="borrow-table-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t flex justify-between items-center">
                            <div class="text-sm text-gray-500">
                                Showing <span id="borrow-start">1</span> to <span id="borrow-end">10</span> of <span id="borrow-total">0</span> entries
                            </div>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 border rounded-lg disabled:opacity-50" id="borrow-prev" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="px-3 py-1 border rounded-lg disabled:opacity-50" id="borrow-next" disabled>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports-section" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">Reports & Analytics</h3>
                        <div class="flex space-x-2">
                            <select class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="report-period">
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-download"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 space-y-4" id="report-summary">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-gray-500">Total Borrowed</div>
                            <div class="text-2xl font-bold" id="report-total-borrowed">0</div>
                        </div>
                        <div>
                            <div class="text-gray-500">Returned</div>
                            <div class="text-2xl font-bold text-green-600" id="report-returned">0</div>
                        </div>
                        <div>
                            <div class="text-gray-500">Overdue</div>
                            <div class="text-2xl font-bold text-red-600" id="report-overdue">0</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
<script>
    const tabs = {
        "dashboard-tab": "dashboard-section",
        "books-tab": "books-section",
        "users-tab": "users-section",
        "borrow-tab": "borrow-section",
        "reports-tab": "reports-section"
    };

    function hideAllSections() {
        Object.values(tabs).forEach(id => {
            document.getElementById(id).classList.add("hidden");
        });
    }

    function resetActiveTabs() {
        Object.keys(tabs).forEach(id => {
            document.getElementById(id).classList.remove("bg-blue-900", "active-tab");
        });
    }

    Object.entries(tabs).forEach(([tabId, sectionId]) => {
        const tab = document.getElementById(tabId);
        tab.addEventListener("click", () => {
            hideAllSections();
            resetActiveTabs();
            document.getElementById(sectionId).classList.remove("hidden");
            tab.classList.add("bg-blue-900", "active-tab");
            const titleMap = {
                "dashboard-section": "Dashboard",
                "books-section": "Books Management",
                "users-section": "Users Management",
                "borrow-section": "Borrow/Return",
                "reports-section": "Reports"
            };
            document.getElementById("page-title").innerText = titleMap[sectionId];
        });
    });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const totalBooksEl = document.getElementById("total-books");
    const totalUsersEl = document.getElementById("total-users");
    const borrowedBooksEl = document.getElementById("borrowed-books");
    const overdueBooksEl = document.getElementById("overdue-books");
    const recentBorrowedEl = document.getElementById("recent-borrowed");
    const popularBooksEl = document.getElementById("popular-books");

    // 1. Thống kê tổng quan
    fetch("/api/dashboard/stats")
        .then(res => res.json())
        .then(data => {
            totalBooksEl.textContent = data.totalBooks;
            totalUsersEl.textContent = data.totalUsers;
            borrowedBooksEl.textContent = data.borrowedBooks;
            overdueBooksEl.textContent = data.overdueBooks;
        })
        .catch(err => console.error("Lỗi khi tải thống kê:", err));

    // 2. Danh sách mượn gần đây
    fetch("/api/borrows/recent")
        .then(res => res.json())
        .then(data => {
            recentBorrowedEl.innerHTML = data.map(item => `
                <tr class="border-b">
                    <td class="py-2">${item.bookTitle}</td>
                    <td class="py-2">${item.userName}</td>
                    <td class="py-2">${item.borrowDate}</td>
                    <td class="py-2">${item.dueDate}</td>
                </tr>
            `).join("");
        })
        .catch(err => console.error("Lỗi khi tải danh sách mượn gần đây:", err));

    // 3. Top sách được mượn nhiều
    fetch("/api/books/popular")
        .then(res => res.json())
        .then(data => {
            popularBooksEl.innerHTML = data.map(book => `
                <div class="bg-gray-100 p-4 rounded-lg shadow">
                    <div class="font-semibold text-sm">${book.title}</div>
                    <div class="text-gray-500 text-xs">${book.author}</div>
                </div>
            `).join("");
        })
        .catch(err => console.error("Lỗi khi tải sách phổ biến:", err));
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const tableBody = document.getElementById("books-table-body");
    const bookSearch = document.getElementById("book-search");
    const bookFilter = document.getElementById("book-filter");
    const bookStart = document.getElementById("book-start");
    const bookEnd = document.getElementById("book-end");
    const bookTotal = document.getElementById("book-total");
    const prevBtn = document.getElementById("book-prev");
    const nextBtn = document.getElementById("book-next");

    const addBookBtn = document.getElementById("add-book-btn");
    const addBookModal = document.getElementById("add-book-modal");
    const cancelAddBook = document.getElementById("cancel-add-book");
    const closeModal = document.getElementById("close-modal");
    const addBookForm = document.getElementById("add-book-form");
    const bookIdInput = document.getElementById("book-id");
    const modalTitle = document.getElementById("modal-title");

    let books = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let editingBookId = null;

    function fetchBooks() {
        fetch("/api/books")
            .then(response => response.json())
            .then(data => {
                books = data;
                renderTable();
            })
            .catch(error => console.error("Lỗi khi tải sách:", error));
    }

    function renderTable() {
        const keyword = bookSearch.value.toLowerCase();
        const filter = bookFilter.value;

        let filtered = books.filter(book => {
            const matchKeyword = book.title.toLowerCase().includes(keyword) ||
                book.author.toLowerCase().includes(keyword) ||
                book.publisher.toLowerCase().includes(keyword);

            if (filter === "available") return matchKeyword && book.quantity > 0;
            if (filter === "borrowed") return matchKeyword && book.quantity === 0;
            return matchKeyword;
        });

        const total = filtered.length;
        const startIdx = (currentPage - 1) * rowsPerPage;
        const endIdx = Math.min(startIdx + rowsPerPage, total);
        const currentPageData = filtered.slice(startIdx, endIdx);

        tableBody.innerHTML = currentPageData.map(book => `
            <tr class="border-b">
                <td class="p-4">${book.id}</td>
                <td class="p-4">${book.title}</td>
                <td class="p-4">${book.author}</td>
                <td class="p-4">${book.publisher}</td>
                <td class="p-4">${book.numPages}</td>
                <td class="p-4">${book.quantity}</td>
                <td class="p-4">
                    <button class="text-blue-600 hover:underline" onclick="editBook(${book.id})">Edit</button>
                    <button class="text-red-600 hover:underline ml-2" onclick="deleteBook(${book.id})">Delete</button>
                </td>
            </tr>
        `).join("");

        bookStart.textContent = total === 0 ? 0 : startIdx + 1;
        bookEnd.textContent = endIdx;
        bookTotal.textContent = total;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = endIdx >= total;
    }

    bookSearch.addEventListener("input", () => {
        currentPage = 1;
        renderTable();
    });

    bookFilter.addEventListener("change", () => {
        currentPage = 1;
        renderTable();
    });

    prevBtn.addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });

    nextBtn.addEventListener("click", () => {
        currentPage++;
        renderTable();
    });

    window.editBook = function (id) {
        const book = books.find(b => b.id === id);
        if (!book) return;

        editingBookId = id;

        addBookForm.title.value = book.title;
        addBookForm.author.value = book.author;
        addBookForm.publisher.value = book.publisher;
        addBookForm.numPages.value = book.numPages;
        addBookForm.quantity.value = book.quantity;
        bookIdInput.value = id;
        modalTitle.textContent = "Edit Book";

        addBookModal.classList.remove("hidden");
        addBookModal.classList.add("flex");
    };

    window.deleteBook = function (id) {
        if (confirm("Bạn có chắc muốn xoá sách này?")) {
            fetch(`/api/books/${id}`, {
                method: "DELETE"
            })
                .then(response => {
                    if (response.ok) {
                        books = books.filter(b => b.id !== id);
                        renderTable();
                    } else {
                        alert("Xoá thất bại!");
                    }
                });
        }
    };

    addBookBtn.addEventListener("click", () => {
        editingBookId = null;
        modalTitle.textContent = "Add New Book";
        addBookForm.reset();
        addBookModal.classList.remove("hidden");
        addBookModal.classList.add("flex");
    });

    cancelAddBook.addEventListener("click", () => {
        addBookModal.classList.add("hidden");
        addBookForm.reset();
        editingBookId = null;
    });

    closeModal.addEventListener("click", () => {
        addBookModal.classList.add("hidden");
        addBookForm.reset();
        editingBookId = null;
    });

    addBookForm.addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(addBookForm);
        const bookData = {
            title: formData.get("title"),
            author: formData.get("author"),
            publisher: formData.get("publisher"),
            numPages: parseInt(formData.get("numPages")),
            quantity: parseInt(formData.get("quantity"))
        };

        const method = editingBookId ? "PUT" : "POST";
        const url = editingBookId ? `/api/books/${editingBookId}` : "/api/books";

        fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(bookData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(editingBookId ? "Không thể cập nhật sách." : "Không thể thêm sách.");
            }
            return response.json();
        })
        .then(savedBook => {
            if (editingBookId) {
                const index = books.findIndex(b => b.id === editingBookId);
                books[index] = savedBook;
            } else {
                books.push(savedBook);
            }

            addBookForm.reset();
            addBookModal.classList.add("hidden");
            editingBookId = null;
            renderTable();
        })
        .catch(error => {
            alert(error.message);
        });
    });

    fetchBooks();
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const userTableBody = document.getElementById("users-table-body");
    const userSearch = document.getElementById("user-search");
    const userStart = document.getElementById("user-start");
    const userEnd = document.getElementById("user-end");
    const userTotal = document.getElementById("user-total");
    const prevBtn = document.getElementById("user-prev");
    const nextBtn = document.getElementById("user-next");

    let users = [];
    let currentPage = 1;
    const rowsPerPage = 10;

    function fetchUsers() {
        fetch("/api/users")
            .then(res => res.json())
            .then(data => {
                users = data;
                renderUserTable();
            })
            .catch(err => console.error("Lỗi khi lấy users:", err));
    }

    function renderUserTable() {
        const keyword = userSearch.value.toLowerCase();
        let filtered = users.filter(user =>
            user.username.toLowerCase().includes(keyword) ||
            user.useremail.toLowerCase().includes(keyword)
        );

        const total = filtered.length;
        const startIdx = (currentPage - 1) * rowsPerPage;
        const endIdx = Math.min(startIdx + rowsPerPage, total);
        const currentPageData = filtered.slice(startIdx, endIdx);

        userTableBody.innerHTML = currentPageData.map(user => `
            <tr class="border-b">
                <td class="p-4">${user.id}</td>
                <td class="p-4">${user.username}</td>
                <td class="p-4">${user.useremail}</td>
                <td class="p-4 text-gray-400 italic">••••••</td>
                <td class="p-4">
                    <button class="text-blue-600 hover:underline" onclick="editUser(${user.id})">Edit</button>
                    <button class="text-red-600 hover:underline ml-2" onclick="deleteUser(${user.id})">Delete</button>
                </td>
            </tr>
        `).join("");

        userStart.textContent = total === 0 ? 0 : startIdx + 1;
        userEnd.textContent = endIdx;
        userTotal.textContent = total;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = endIdx >= total;
    }

    userSearch.addEventListener("input", () => {
        currentPage = 1;
        renderUserTable();
    });

    prevBtn.addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            renderUserTable();
        }
    });

    nextBtn.addEventListener("click", () => {
        currentPage++;
        renderUserTable();
    });

    window.editUser = function (id) {
        alert("Sửa user ID " + id);
        // Chuyển hướng tới form hoặc hiển thị popup
    };

    window.deleteUser = function (id) {
        if (confirm("Bạn có chắc muốn xoá người dùng này?")) {
            fetch(`/api/users/${id}`, {
                method: "DELETE"
            }).then(response => {
                if (response.ok) {
                    users = users.filter(u => u.id !== id);
                    renderUserTable();
                } else {
                    alert("Xoá thất bại!");
                }
            });
        }
    };

    fetchUsers();
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const tableBody = document.getElementById("borrow-table-body");
    const searchInput = document.getElementById("borrow-search");
    const statusFilter = document.getElementById("borrow-status");
    const dateFilter = document.getElementById("borrow-date");
    const startSpan = document.getElementById("borrow-start");
    const endSpan = document.getElementById("borrow-end");
    const totalSpan = document.getElementById("borrow-total");
    const prevBtn = document.getElementById("borrow-prev");
    const nextBtn = document.getElementById("borrow-next");

    let borrowSlips = [];
    let currentPage = 1;
    const rowsPerPage = 10;

    function fetchBorrowSlips() {
        fetch("/api/borrow-slips")
            .then(res => res.json())
            .then(data => {
                borrowSlips = data;
                renderTable();
            })
            .catch(err => console.error("Lỗi khi tải borrow slips:", err));
    }

    function renderTable() {
        const keyword = searchInput.value.toLowerCase();
        const selectedStatus = statusFilter.value;
        const selectedDate = dateFilter.value;

        let filtered = borrowSlips.filter(slip => {
            const matchKeyword = slip.user.username.toLowerCase().includes(keyword) ||
                                 slip.book.title.toLowerCase().includes(keyword);

            let matchStatus = true;
            if (selectedStatus === "borrowed") matchStatus = !slip.returned;
            else if (selectedStatus === "returned") matchStatus = slip.returned;
            else if (selectedStatus === "overdue") {
                const today = new Date().toISOString().split('T')[0];
                matchStatus = !slip.returned && slip.dueDate < today;
            }

            let matchDate = true;
            if (selectedDate) matchDate = slip.borrowDate === selectedDate;

            return matchKeyword && matchStatus && matchDate;
        });

        const total = filtered.length;
        const startIdx = (currentPage - 1) * rowsPerPage;
        const endIdx = Math.min(startIdx + rowsPerPage, total);
        const pageData = filtered.slice(startIdx, endIdx);

        tableBody.innerHTML = pageData.map(slip => `
            <tr class="border-b">
                <td class="p-4">${slip.id}</td>
                <td class="p-4">${slip.user.username}</td>
                <td class="p-4">${slip.book.title}</td>
                <td class="p-4">${slip.borrowDate}</td>
                <td class="p-4">${slip.dueDate}</td>
                <td class="p-4">${slip.returned ? slip.returnDate || "✔" : "-"}</td>
                <td class="p-4">
                    ${slip.returned ? `<span class="text-green-600">Returned</span>` :
                    `<span class="text-yellow-600">${isOverdue(slip.dueDate) ? "Overdue" : "Borrowed"}</span>`}
                </td>
                <td class="p-4">
                    ${slip.returned ? '' :
                    `<button class="text-blue-600 hover:underline" onclick="returnBook(${slip.id})">Return</button>`}
                </td>
            </tr>
        `).join("");

        startSpan.textContent = total === 0 ? 0 : startIdx + 1;
        endSpan.textContent = endIdx;
        totalSpan.textContent = total;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = endIdx >= total;
    }

    function isOverdue(dueDate) {
        const today = new Date().toISOString().split('T')[0];
        return dueDate < today;
    }

    searchInput.addEventListener("input", () => {
        currentPage = 1;
        renderTable();
    });

    statusFilter.addEventListener("change", () => {
        currentPage = 1;
        renderTable();
    });

    dateFilter.addEventListener("input", () => {
        currentPage = 1;
        renderTable();
    });

    prevBtn.addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });

    nextBtn.addEventListener("click", () => {
        currentPage++;
        renderTable();
    });

    window.returnBook = function (id) {
        if (confirm("Xác nhận đã trả sách?")) {
            fetch(`/api/borrow-slips/${id}/return`, {
                method: "PUT"
            }).then(res => {
                if (res.ok) {
                    const slip = borrowSlips.find(s => s.id === id);
                    if (slip) slip.returned = true;
                    renderTable();
                } else {
                    alert("Trả sách thất bại!");
                }
            });
        }
    };

    fetchBorrowSlips();
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const periodSelect = document.getElementById("report-period");
    const totalBorrowed = document.getElementById("report-total-borrowed");
    const totalReturned = document.getElementById("report-returned");
    const totalOverdue = document.getElementById("report-overdue");

    function fetchReport() {
        const period = periodSelect.value;

        fetch(`/api/reports?period=${period}`)
            .then(res => res.json())
            .then(data => {
                totalBorrowed.textContent = data.totalBorrowed;
                totalReturned.textContent = data.totalReturned;
                totalOverdue.textContent = data.totalOverdue;
            })
            .catch(err => console.error("Lỗi khi tải báo cáo:", err));
    }

    periodSelect.addEventListener("change", fetchReport);

    fetchReport(); // Load mặc định khi vào trang
});
</script>

</body>
</html>
